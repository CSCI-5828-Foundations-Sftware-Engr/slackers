# Database
Our system uses PostgreSQL. In order to interact with the database, use the `com.goodboards.db` package defined in the `db-interface` component.

## Database Specifications

### Fast Facts
- Database: `goodboards`
- Schema: `goodboards`
    - All tables are defined under this schema.
- Tables:
    - `games` - contains all game data. Tracks UUID, name, and description of the game
    - `news` - contains all news data per game retrieved from the database. Tracks the ID, title, and description of each news article.
- Note that UUIDs are auto-generated by the database, using the `uuid-ossp` extension.

### Local Setup
1. Install [postgres](https://wiki.postgresql.org/wiki/Homebrew) (it should come with the `psql` command line tool)
2. Start the Postgres server 
   1. For Mac:`brew services start postgresql`
   2. See [this resource](https://tableplus.com/blog/2018/10/how-to-start-stop-restart-postgresql-server.html) for other operating systems
3. Create an auxilary Postgres account that the system can use to login to the database:
   1. `psql postgres` to open the DB connection command line, authenticated via your admin account
   2. Create a user with your desired username and password
      1. `CREATE ROLE <YOUR_USERNAME> WITH LOGIN PASSWORD '<YOUR_PASSWORD>';`
      2. `ALTER ROLE <YOUR_USERNAME> CREATEDB;`
   3. Type `exit` to leave the database prompt
4. Login as your newly created user: `psql postgres -U <YOUR_USERNAME>`
5. Create the DB: `CREATE DATABASE goodboards;`
6. Create the schema: 
   1. Connect to the `goodboards` DB: `\c goodboards`
   2. Create: `CREATE SCHEMA goodboards;`
7. Ensure the `uuid-ossp` extension exists: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp";`
8. Create tables in the `goodboards` schema:
```roomsql
/* Games Table */
CREATE TABLE goodboards.games (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(255) NOT NULL
);

/* News Table */
CREATE TABLE goodboards.news (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    gameId VARCHAR(255) NOT NULL,
    title VARCHAR(255) NOT NULL,
    url VARCHAR(255) NOT NULL,
    description VARCHAR(255)
);

```

## Database Interface
- Uses the JDBC Java library to connect
- Requires 3 environment variables. Set using `export <VARIABLE>=<VALUE>` or update `.bashrc`
  - `JDBC_DATABASE_URL`: postgres host 
    - For a local instance, it should look like: `jdbc:postgresql://localhost:5432/${DATABASE_NAME}`
    - Our `${DATABASE_NAME}` is `goodboards`. Note that not every local instance requires this database name (i.e. you may have to leave it off)
  - `DATABASE_USERNAME`: Postgres username
  - `DATABASE_PASSWORD`: Postgres password

### Package Contents
Main Components:
- `DBInterface` - Class for querying the database.
- `DBConnection` - Object for making a Singleton database connection.

Utilities: 
- `Game` - Model for game data
- `SystemWrapper` - Wrapper for the `System` Java library. For unit testing.
- `DriverManagerWrapper` - Wrapper for the `java.sql.DriverManager` library. For unit testing.

### Functions
The available actions represent the majority of CRUD operations for database (minus `Update`, since there's no reason to modify the games after we load them.)

#### Constructor
```kotlin
// @param: DBConnection, getting the connection to the database
// @return: DBInterface
fun DBInterface() : Boolean
```
Creating an interface. Note that it is necessary to set the connection first.

_Example_
```kotlin
// Get database environment variables first
val url = System.getenv("DATABASE_URL")
val user = System.getenv("DATABASE_USERNAME")
val pass = System.getenv("DATABASE_PASSWORD")

// Set the connection
DBConnection.setConnection(url, user, pass)

// Now you can create the DBInterface
val dbInterface = DBInterface(DBConnection)
```

#### isConnected()
```kotlin
// @param: None
// @return: Boolean, `true` if connection is valid, `false` otherwise.
fun isConnected() : Boolean
```
For checking whether the database connection is valid.

_Example_
```kotlin
val dbInterface = DBInterface(DBConnection)
dbInterface.isConnected()
```

#### getAllGames()
```kotlin
// @param: None
// @return: List, contains all Game objects retrieved from database
fun getAllGames() : List<Game>
```
Selects all games from the `goodboards.games` table.

_Example_
```kotlin
val dbInterface = DBInterface(DBConnection)
val games = dbInterface.getAllGames()
```

#### getGameById()
```kotlin
// @param: String, uuid of the game
// @return: Game
fun getGameById(id: String) : Game
```
Return `Game` object with corresponding ID. Throws an error if the ID doesn't exist or is found multiple times.

_Example_
```kotlin
val dbInterface = DBInterface(DBConnection)
val game = dbInterface.getGameById("46ab38e7-0d1e-4b25-86b9-9388726f8e82")
```

#### addGame()
```kotlin
// @param: String, name of the game
// @param: String, description of the game
// @return: None
fun addGame(name: String, description: String)
```
Adds a game with the provided data to the database.

_Example_
```kotlin
val dbInterface = DBInterface(DBConnection)
dbInterface.addGame("Chess", "A Classic")
```

#### getGameByName()
```kotlin
// @param: String, name of the game
// @return: Game, with the given name
fun getGameByName(name: String) : Game
```
Return `Game` object with corresponding name. Throws an error if the name doesn't exist or is found multiple times.

_Example_
```kotlin
val dbInterface = DBInterface(DBConnection)
val game = dbInterface.getGameByName("Chess")
```

#### deleteGameById()
```kotlin
// @param: String, uuid of the game
// @return: Boolean, whether the game deleted successfully (true)
fun deleteGameById(uuid: String): Boolean
```
Deletes game from database. Returns `true` if successful.

_Example_
```kotlin
val dbInterface = DBInterface(DBConnection)
val status = dbInterface.deleteGameById("46ab38e7-0d1e-4b25-86b9-9388726f8e82")
```

## TODOs
- Unit tests for `addGame()` and `deleteGameById()`